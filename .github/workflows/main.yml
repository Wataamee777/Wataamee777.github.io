name: Generate Pages JSON (with CNAME)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *" # 毎日1回（UTC 00:00 / JST 09:00）

permissions:
  contents: write

jobs:
  generate:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Generate pages.json
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p data
          OWNER="${{ github.repository_owner }}"
          ORGS=("hatoage-team") # ← 組織名

          echo "[]" > data/pages.json

          fetch_pages () {
            local OWNER_NAME="$1"
            local TYPE="$2" # user / org

            gh api $TYPE/$OWNER_NAME/repos --paginate \
              --jq '.[] | select(.has_pages == true) | {
                name: .name,
                owner: "'$OWNER_NAME'",
                updated: .updated_at
              }' | while read -r repo; do
                NAME=$(echo "$repo" | jq -r .name)

                # Pages API（CNAME取得）
                PAGE_INFO=$(gh api repos/$OWNER_NAME/$NAME/pages 2>/dev/null || true)
                CNAME=$(echo "$PAGE_INFO" | jq -r '.cname // null')

                jq -n \
                  --arg name "$NAME" \
                  --arg owner "$OWNER_NAME" \
                  --arg updated "$(echo "$repo" | jq -r .updated)" \
                  --arg cname "$CNAME" \
                  '{
                    name: $name,
                    owner: $owner,
                    url: ("https://" + $owner + ".github.io/" + $name + "/"),
                    cname: ($cname == "" ? null : $cname),
                    updated: $updated
                  }'
              done
          }

          # 個人
          fetch_pages "$OWNER" "users" >> data/pages.json

          # 組織
          for ORG in "${ORGS[@]}"; do
            fetch_pages "$ORG" "orgs" >> data/pages.json
          done

          # 正規化（配列1個）
          jq -s '[.[]] | sort_by(.updated) | reverse' data/pages.json > data/pages.tmp
          mv data/pages.tmp data/pages.json

      - name: Commit pages.json
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add data/pages.json
          git commit -m "update pages.json with cname" || true
          git push
